<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>We have touchpad at home</title>
	<style>
		html,
		body,
		#toucharea {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			background-color: black;
		}

		#buttons {
			position: absolute;
			top: 10px;
			left: 10px;
			z-index: 9999;
		}

		.button {
			color: #555;
			padding: 10px;
			background: none;
			border: 1px dotted #555;
		}
	</style>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const buttons = document.getElementById('buttons');
			const toucharea = document.getElementById('toucharea');
			const fullscreenButton = document.getElementById('fullscreen-button');
			const reconnectButton = document.getElementById('reconnect-button');

			setInterval(() => {
				// Randomly offset buttons by 5px to 20px on the x and y axis by changing their top and left properties
				buttons.style.top = `${Math.random() * 15 + 5}px`;
				buttons.style.left = `${Math.random() * 15 + 5}px`;
			}, 60 * 1000);

			/**
			 * Protocol (angle brackets are to be omitted):
			 * - 0 <width> <height>: Initialize a new device with dimensions width and height
			 * - 1 <identifier> <x> <y>: Simulate a new touch contact at slot with coordinates x and y
			 * - 2 <identifier>: Simulate a touch contact being lifted
			 */
			let socket;
			init_socket();

			function init_socket() {
				if (socket) {
					socket.close();
				}

				socket = new WebSocket("ws://" + location.host + "/ws");
				reconnectButton.textContent = 'Connecting...';

				// Event listener for WebSocket open
				socket.addEventListener('open', (event) => {
					send_dimensions();
					console.log('WebSocket connection opened');
					reconnectButton.textContent = 'Connected :)';
				});

				socket.addEventListener('close', (event) => {
					console.log('WebSocket connection closed');
					reconnectButton.textContent = 'Disconnected :(';
				});

				socket.addEventListener('error', (error) => {
					console.error('WebSocket error:', error);
					reconnectButton.textContent = 'Disconnected :(';
				});
			}

			function send_dimensions() {
				socket.send(`0 ${Math.round(toucharea.clientWidth)} ${Math.round(toucharea.clientHeight)}\n`);
			}

			function handleTouch(evt) {
				evt.preventDefault();
				evt.stopImmediatePropagation();

				for (const touch of evt.changedTouches) {
					socket.send(`1 ${touch.identifier} ${Math.round(touch.clientX)} ${Math.round(touch.clientY)}\n`);
				}
			}

			function handleTouchEnd(evt) {
				evt.preventDefault();
				evt.stopImmediatePropagation();

				for (const touch of evt.changedTouches) {
					socket.send(`2 ${touch.identifier}\n`);
				}
			}

			toucharea.addEventListener('touchstart', handleTouch);
			toucharea.addEventListener('touchmove', handleTouch);

			toucharea.addEventListener("touchend", handleTouchEnd);
			toucharea.addEventListener("touchcancel", handleTouchEnd);

			window.addEventListener("resize", send_dimensions)

			// Fullscreen button functionality
			fullscreenButton.addEventListener('click', (evt) => {
				if (document.fullscreenElement) {
					document.exitFullscreen();
					screen.orientation.unlock();
					fullscreenButton.innerText = 'Fullscreen';
				} else {
					if (document.body.requestFullscreen) {
						document.body.requestFullscreen();
						screen.orientation.lock('landscape');
						fullscreenButton.innerText = 'Exit Fullscreen';
					}
				}
			});

			reconnectButton.addEventListener('click', (evt) => {
				init_socket();
			});
		})
	</script>
</head>

<body>
	<div id="buttons">
		<button class="button" id="fullscreen-button">Fullscreen</button>
		<button class="button" id="reconnect-button"></button>
	</div>

	<div id="toucharea"></div>
</body>

</html>